

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>polyglot.nodeserver_api &mdash; Polyglot alpha documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Polyglot alpha documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Polyglot
          

          
          </a>

          
            
            
              <div class="version">
                alpha
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsdev.html">Node Server Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsexample.html">Python Node Server Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsapi.html">Polyglot Node Server API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Polyglot</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>polyglot.nodeserver_api</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for polyglot.nodeserver_api</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This library consists of four classes and one function to assist with node</span>
<span class="sd">server development. The classes :class:`polyglot.nodeserver_api.NodeServer` and</span>
<span class="sd">:class:`polyglot.nodeserver_api.SimpleNodeServer` and basic structures for</span>
<span class="sd">creating a node server. The class :class:`polyglot.nodeserver_api.Node` is</span>
<span class="sd">used as an abstract class to crate custom nodes for node servers.  The class</span>
<span class="sd">:class:`polyglot.nodeserver_api.PolyglotConnector` is a bottom level</span>
<span class="sd">implimentation of the API used to communicate between Polyglot and your</span>
<span class="sd">node server. Finally, included in this library is a method decorator,</span>
<span class="sd">:meth:`polyglot.nodeserver_api.auto_request_report`, that wraps functions and</span>
<span class="sd">methods to automatically handle report requests from the ISY.</span>

<span class="sd">.. decorator: PolyglotConnector</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">polyglot.utils</span> <span class="kn">import</span> <span class="n">AsyncFileReader</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">LockQueue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">_POLYGLOT_CONNECTION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">OUTPUT_DELAY</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="auto_request_report"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.auto_request_report">[docs]</a><span class="k">def</span> <span class="nf">auto_request_report</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python decorator to automate request reporting. Decorated functions must</span>
<span class="sd">    return a boolean value indicating their success or failure. It the</span>
<span class="sd">    argument *request_id* is passed to the decorated function, a response will</span>
<span class="sd">    be sent to the ISY. This decorator is implimented in the SimpleNodeServer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">auto_request_report_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handler function wrapper to automatically report request status to ISY</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request_id</span> <span class="ow">and</span> <span class="n">_POLYGLOT_CONNECTION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_POLYGLOT_CONNECTION</span><span class="o">.</span><span class="n">report_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span>
                                                       <span class="nb">bool</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">success</span>
    <span class="k">return</span> <span class="n">auto_request_report_wrapper</span>

</div>
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class for representing a node in a node server.</span>

<span class="sd">    :param parent: The node server that controls the node</span>
<span class="sd">    :type parent: polyglot.nodeserver_api.NodeServer</span>
<span class="sd">    :param str address: The address of the node in the ISY without the node</span>
<span class="sd">                        server ID prefix</span>
<span class="sd">    :param str name: The name of the node</span>
<span class="sd">    :param manifest: The node manifest saved by the node server</span>
<span class="sd">    :type manifest: dict or None</span>

<span class="sd">    .. document private methods</span>
<span class="sd">    .. autoattribute:: _drivers</span>
<span class="sd">    .. autoattribute:: _commands</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">manifest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update driver values from manifest &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">)</span>

        <span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">manifest</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">manifest</span> <span class="o">==</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;added&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">drivers</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;drivers&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">drivers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">new_node</span><span class="p">:</span>
            <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">primary</span> <span class="o">=</span> <span class="n">all_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">primary</span> <span class="o">=</span> <span class="n">address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>

<div class="viewcode-block" id="Node.run_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.run_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs one of the node&#39;s commands.</span>

<span class="sd">        :param str command: The name of the command</span>
<span class="sd">        :param dict kwargs: The parameters specified by the ISY in the</span>
<span class="sd">                            incoming request. See the ISY Node Server</span>
<span class="sd">                            documentation for more information.</span>
<span class="sd">        :returns boolean: Indicates success or failure of command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="n">command</span><span class="p">]</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Node.set_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.set_driver">[docs]</a>    <span class="k">def</span> <span class="nf">set_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the value of one of the node&#39;s drivers. This will pass the</span>
<span class="sd">        given value through the driver&#39;s formatter before assignment.</span>

<span class="sd">        :param str driver: The name of the driver</span>
<span class="sd">        :param value: The new value for the driver</span>
<span class="sd">        :param uom: The given values unit of measurement. This should</span>
<span class="sd">                    correspond to the UOM IDs used by the ISY. Refer to the ISY</span>
<span class="sd">                    documentation for more information.</span>
<span class="sd">        :type uom: int or None</span>
<span class="sd">        :param boolean report: Indicates if the value change should be reported</span>
<span class="sd">                               to the ISY. If False, the value is changed</span>
<span class="sd">                               silently.</span>
<span class="sd">        :returns boolean: Indicates success or failure to set new value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=unused-argument</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
            <span class="n">clean_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clean_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_value</span>
                <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Node.report_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.report_driver">[docs]</a>    <span class="k">def</span> <span class="nf">report_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reports a driver&#39;s current value to ISY</span>

<span class="sd">        :param driver: The name of the driver to report. If None, all drivers</span>
<span class="sd">                       are reported.</span>
<span class="sd">        :type driver: str or None</span>
<span class="sd">        :returns boolean: Indicates success or failure to report driver value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">drivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drivers</span> <span class="o">=</span> <span class="p">[</span><span class="n">driver</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">report_status</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node.get_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.get_driver">[docs]</a>    <span class="k">def</span> <span class="nf">get_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a driver&#39;s value</span>

<span class="sd">        :param driver: The driver to return the value for</span>
<span class="sd">        :type driver: str or None</span>
<span class="sd">        :returns: The current value of the driver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span>
</div>
<div class="viewcode-block" id="Node.query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstractly queries the node. This method should generally be</span>
<span class="sd">        overwritten in development.</span>

<span class="sd">        :returns boolean: Indicates success or failure of node query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds node to the ISY</span>

<span class="sd">        :param str primary_addr: The node server&#39;s primary node address</span>
<span class="sd">        :returns boolean: Indicates success or failure of node addition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The node&#39;s manifest entry. Indicates the current value of each of the</span>
<span class="sd">        drivers. This is called by the node server to create the full manifest.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;added&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">,</span>
                    <span class="s">&#39;node_def_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">}</span>
        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">manifest</span>


    <span class="n">_drivers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The drivers controlled by this node. This is a dictionary of lists. The</span>
<span class="sd">    key&#39;s are the driver names as defined by the ISY documentation. Each list</span>
<span class="sd">    contains three values: the initial value, the UOM identifier, and a</span>
<span class="sd">    function that will properly format the value before assignment.</span>

<span class="sd">    *Insteon Dimmer Example:*</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        _drivers = {</span>
<span class="sd">            &#39;ST&#39;: [0, 51, int],</span>
<span class="sd">            &#39;OL&#39;: [100, 51, int],</span>
<span class="sd">            &#39;RR&#39;: [0, 32, int]</span>
<span class="sd">        }</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_commands</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dictionary of the commands that the node can perform. The keys of this</span>
<span class="sd">    dictionary are the names of the command. The values are functions that must</span>
<span class="sd">    be defined in the node object that perform the necessary actions and return</span>
<span class="sd">    a boolean indicating the success or failure of the command.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">node_def_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot; The node&#39;s definition ID defined in the node server&#39;s profile &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="NodeServer"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer">[docs]</a><span class="k">class</span> <span class="nc">NodeServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It is generally desireable to not be required to bind to each event. For</span>
<span class="sd">    this reason, the NodeServer abstract class is available. This class should</span>
<span class="sd">    be abstracted. It binds appropriate handlers to the API events and contains</span>
<span class="sd">    a suitable run loop. It should serve as a basic structure for any node</span>
<span class="sd">    server.</span>

<span class="sd">    :param poly: The connected Polyglot connection</span>
<span class="sd">    :type poly: polyglot.nodeserver_api.PolyglotConnector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># pylint: disable=unused-argument</span>

    <span class="n">poly</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Polyglot Connection</span>

<span class="sd">    :type: polyglot.nodeserver_api.PolyglotConnector</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
        <span class="c"># create/store properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span> <span class="o">=</span> <span class="n">poly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># bind callbacks to events</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_config</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;install&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_install</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_query</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_status</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;add_all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_add_all</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;added&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_added</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;removed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_removed</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;renamed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_renamed</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;enabled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_enabled</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_disabled</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;cmd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_cmd</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;exit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">)</span>

<div class="viewcode-block" id="NodeServer.on_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_config">[docs]</a>    <span class="k">def</span> <span class="nf">on_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received configuration data from Polyglot</span>

<span class="sd">        :param dict data: Configuration data</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.on_install"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_install">[docs]</a>    <span class="k">def</span> <span class="nf">on_install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received install command from ISY</span>

<span class="sd">        :param int profile_number: Noder Server&#39;s profile number</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_query">[docs]</a>    <span class="k">def</span> <span class="nf">on_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received query command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_status">[docs]</a>    <span class="k">def</span> <span class="nf">on_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received status command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_add_all"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_add_all">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received add all command from ISY</span>

<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_added"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_added">[docs]</a>    <span class="k">def</span> <span class="nf">on_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node added report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str node_def_id: The node definition id</span>
<span class="sd">        :param str primary_node_address: The node server&#39;s primary node address</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_removed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_removed">[docs]</a>    <span class="k">def</span> <span class="nf">on_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node removed report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_renamed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_renamed">[docs]</a>    <span class="k">def</span> <span class="nf">on_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node renamed report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_enabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node enabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_disabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node disabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">on_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received run command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str command: The command to run</span>
<span class="sd">        :param optional value: The value of the command&#39;s unnamed parameter</span>
<span class="sd">        :param optional uom: The units of measurement for the unnamed parameter</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: The value of parameter pN with units uomN</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_exit">[docs]</a>    <span class="k">def</span> <span class="nf">on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polyglot has triggered a clean shutdown. Generally, this method does</span>
<span class="sd">        not need to be orwritten.</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.poll"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every second to allow for updating nodes. &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NodeServer.long_poll"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.long_poll">[docs]</a>    <span class="k">def</span> <span class="nf">long_poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every thirty seconds for less important polling. &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=no-self-use</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NodeServer.run"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Node Server. Exit when triggered. Generally, this method should</span>
<span class="sd">        not be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">long_poll</span><span class="p">()</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="SimpleNodeServer"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer">[docs]</a><span class="k">class</span> <span class="nc">SimpleNodeServer</span><span class="p">(</span><span class="n">NodeServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple Node Server with basic functionality built-in. This class inherits</span>
<span class="sd">    from :class:`polyglot.nodeserver_api.NodeServer` and is the best starting</span>
<span class="sd">    point when developing a new node server. This class impliments the idea of</span>
<span class="sd">    manifests which are dictionaries that contain the relevant information</span>
<span class="sd">    about all of the nodes. The manifest gets sent to Polyglot to be saved as</span>
<span class="sd">    part of the configuration. This allows the node server to automatically</span>
<span class="sd">    recall its last known values when it is restarted.</span>

<span class="sd">    .. decorated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nodes registered with this node server. The first node will be the</span>
<span class="sd">    primary node and cannot be removed. Additional nodes can be registered with</span>
<span class="sd">    the server by adding them to this dictionary. The keys are the node IDs</span>
<span class="sd">    while the values are instances of :class:`polyglot.nodeserver_api.Node`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimpleNodeServer.update_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.update_config">[docs]</a>    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the configuration with new node manifests and sends</span>
<span class="sd">        the configuration to Polyglot to be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node_addr</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="n">node_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;manifest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">send_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_query">[docs]</a>    <span class="k">def</span> <span class="nf">on_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries each node and reports all control values to the ISY. Also</span>
<span class="sd">        responds to report requests if necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">node_address</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">query</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_status">[docs]</a>    <span class="k">def</span> <span class="nf">on_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reports the requested node&#39;s control values to the ISY without forcing</span>
<span class="sd">        a query. Also sends requests reponses when necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">node_address</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_add_all"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_add_all">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds all nodes to the ISY. Also sends requests reponses when necessary.</span>

<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="n">all_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">node</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_added"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_added">[docs]</a>    <span class="k">def</span> <span class="nf">on_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internally indicates that the specified node has been added to the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str node_def_id: The node definition id</span>
<span class="sd">        :param str primary_node_address: The node server&#39;s primary node address</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_removed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_removed">[docs]</a>    <span class="k">def</span> <span class="nf">on_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internally indicates that a node has been removed from the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_renamed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_renamed">[docs]</a>    <span class="k">def</span> <span class="nf">on_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the node name internally to match the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">on_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the specified command on the specified node. Also sends requests</span>
<span class="sd">        reponses when necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str command: The command to run</span>
<span class="sd">        :param optional value: The value of the command&#39;s unnamed parameter</span>
<span class="sd">        :param optional uom: The units of measurement for the unnamed parameter</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: The value of parameter pN with units uomN</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="n">uom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_exit">[docs]</a>    <span class="k">def</span> <span class="nf">on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Triggers a clean shut down of the node server by saving the manifest,</span>
<span class="sd">        clearing the IO, and stopping.</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># save manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">()</span>

        <span class="c"># cleanly close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

</div></div>
<div class="viewcode-block" id="PolyglotConnector"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector">[docs]</a><span class="k">class</span> <span class="nc">PolyglotConnector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Polyglot API implimentation. Connects to Polyglot and handles node server</span>
<span class="sd">    IO.</span>

<span class="sd">    :raises: RuntimeError</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># pylint: disable=too-many-instance-attributes</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;install&#39;</span><span class="p">,</span> <span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;add_all&#39;</span><span class="p">,</span> <span class="s">&#39;added&#39;</span><span class="p">,</span>
                <span class="s">&#39;removed&#39;</span><span class="p">,</span> <span class="s">&#39;renamed&#39;</span><span class="p">,</span> <span class="s">&#39;enabled&#39;</span><span class="p">,</span> <span class="s">&#39;disabled&#39;</span><span class="p">,</span> <span class="s">&#39;cmd&#39;</span><span class="p">,</span> <span class="s">&#39;ping&#39;</span><span class="p">,</span>
                <span class="s">&#39;exit&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot; Commands that may be invoked by Polyglot &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># make singleton</span>
        <span class="c"># pylint: disable=global-statement</span>
        <span class="k">global</span> <span class="n">_POLYGLOT_CONNECTION</span>
        <span class="k">if</span> <span class="n">_POLYGLOT_CONNECTION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;PolyglotConnector may only be created once.&#39;</span><span class="p">)</span>

        <span class="c"># setup properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span> <span class="o">=</span> <span class="n">LockQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span> <span class="o">=</span> <span class="n">LockQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># listen for important events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;ping&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_config</span><span class="p">)</span>

        <span class="c"># setup logging - redirect warnings and errors to stderr</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(name)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="c"># store connection globally in module</span>
        <span class="n">_POLYGLOT_CONNECTION</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uptime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of sections the connection with Polyglot has been alive</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span>

    <span class="c"># manage connection</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates if the object is connected to Polyglot. Can be set to control</span>
<span class="sd">        connection with Polyglot.</span>

<span class="sd">        :type: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isAlive</span><span class="p">()</span>

    <span class="nd">@connected.setter</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setter that connects object to Polyglot &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<div class="viewcode-block" id="PolyglotConnector.connect"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connects to Polyglot if not currently connected &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stdin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AsyncFileReader</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s">&#39;stderr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.disconnect"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnects from Polyglot. Blocks the thread until IO stream is clear</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.wait_for_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.wait_for_config">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Blocks the thread until the configuration is received &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># manage output</span></div>
    <span class="k">def</span> <span class="nf">_send_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send output through pipe &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_send_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send error through pipe &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c"># manage input</span>
    <span class="k">def</span> <span class="nf">_parse_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses a received command.</span>

<span class="sd">        :param cmd: String command received from Polyglot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># parse command</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s">&#39;Received badly formatted command &#39;</span> <span class="o">+</span>
                                <span class="s">&#39;(not json): {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c"># split command</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd_code</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">cmd_code</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s">&#39;Received badly formatted command: {} &#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c"># validate command</span>
            <span class="k">if</span> <span class="n">cmd_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s">&#39;Received invalid command: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c"># execute command</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle command was received.</span>

<span class="sd">        :param cmd: The command that has been received</span>
<span class="sd">        :param data: Dictionary of received data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=broad-except</span>
        <span class="n">success</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">cmd_code</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;--debug&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">fun_name</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">__name__</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s">&#39;Error handling {} in function {}: {}&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">fun_name</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">fun_name</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">__name__</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s">&#39;Unsuccessful handling {} in function {}&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">fun_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recv_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; note that the config has been received. &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c"># create output</span>
    <span class="k">def</span> <span class="nf">_mk_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue a command to be sent back to Polyglot.</span>

<span class="sd">        :param cmd_code: Command code</span>
<span class="sd">        :param args: arguments to send with command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">cmd_code</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<div class="viewcode-block" id="PolyglotConnector.send_error"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.send_error">[docs]</a>    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue an error to be sent back to Polyglot.</span>

<span class="sd">        :param str err_str: Error text to be sent to Polyglot log</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">err_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.send_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.send_config">[docs]</a>    <span class="k">def</span> <span class="nf">send_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the configuration in Polyglot.</span>

<span class="sd">        :param dict config_data: Dictionary of updated configuration</span>
<span class="sd">        :raises: ValueError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;send_config: config_data must be dictionary&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.install"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to install the node server in the ISY. This has not</span>
<span class="sd">        been implimented yet and running it will raise an error.</span>

<span class="sd">        :raises: NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># [future] implement when documentation is available</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;install function has not been implemented&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the ISY with the current value of a driver control (e.g. the</span>
<span class="sd">        current temperature, light level, etc.)</span>

<span class="sd">        :param  str node_address: The full address of the node (e.g.</span>
<span class="sd">                                  &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str driver_control: The name of the status value (e.g. &#39;ST&#39;,</span>
<span class="sd">                                   &#39;CLIHUM&#39;, etc.)</span>
<span class="sd">        :param value: The numeric status value (e.g. &#39;80.5&#39;)</span>
<span class="sd">        :type value: str, float, or int</span>
<span class="sd">        :param uom: Unit of measure of the status value</span>
<span class="sd">        :type uom: int or str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">,</span>
                     <span class="n">driver_control</span><span class="o">=</span><span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="n">uom</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_command"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_command">[docs]</a>    <span class="k">def</span> <span class="nf">report_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a command to the ISY that may be used in programs and/or scenes.</span>
<span class="sd">        A common use of this is a physical switch that somebody turns on or</span>
<span class="sd">        off. Each time the switch is used, a command should be reported to the</span>
<span class="sd">        ISY. These are used for scenes and control conditions in ISY programs.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g. &#39;switch_1)</span>
<span class="sd">        :param str command: The command to perform (e.g. &#39;DON&#39;, &#39;CLISPH&#39;, etc.)</span>
<span class="sd">        :param value: Optional unnamed value the command used</span>
<span class="sd">        :type value: str, int, or float</span>
<span class="sd">        :param uom: Optional units of measurement of value</span>
<span class="sd">        :type uom: int or str</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: Nth Parameter name (e.g. &#39;level&#39;) . Unit</span>
<span class="sd">                                     of measure of the Nth parameter</span>
<span class="sd">                                     (e.g. &#39;seconds&#39;, &#39;uom58&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;node_address&#39;</span><span class="p">:</span> <span class="n">node_address</span><span class="p">,</span> <span class="s">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">uom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;uom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a node to the ISY. To make this node the primary, set primary to</span>
<span class="sd">        the same value as node_address.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str node_def_id: The id of the node definition to use for this</span>
<span class="sd">                                node</span>
<span class="sd">        :param str primary: The primary node for the device this node</span>
<span class="sd">                            belongs to</span>
<span class="sd">        :param str name: The name of the node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;node_address&#39;</span><span class="p">:</span> <span class="n">node_address</span><span class="p">,</span> <span class="s">&#39;node_def_id&#39;</span><span class="p">:</span> <span class="n">node_def_id</span><span class="p">,</span>
                <span class="s">&#39;primary&#39;</span><span class="p">:</span> <span class="n">primary</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.change_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.change_node">[docs]</a>    <span class="k">def</span> <span class="nf">change_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the node definition to use for an existing node. An example of</span>
<span class="sd">        this is may be to change a thermostat node from Fahrenheit to Celsius.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str node_def_id: The id of the node definition to use for this</span>
<span class="sd">                                node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">,</span>
                     <span class="n">node_def_id</span><span class="o">=</span><span class="n">node_def_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.remove_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.remove_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a node from the ISY. A node cannot be removed if it is the</span>
<span class="sd">        primary node for at least one other node.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;remove&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_request_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_request_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_request_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">success</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the ISY sends a request to the node server, the request may</span>
<span class="sd">        contain a &#39;requestId&#39; field. This indicates to the node server that</span>
<span class="sd">        when the request is completed, it must send a fail or success report</span>
<span class="sd">        for that request. This allows the ISY to in effect, have the node</span>
<span class="sd">        server synchronously perform tasks. This message must be sent after all</span>
<span class="sd">        other messages related to the task have been sent.</span>

<span class="sd">        For example, if the ISY sends a request to query a node, all the</span>
<span class="sd">        results of the query must be sent to the ISY before a fail/success</span>
<span class="sd">        report is sent.</span>

<span class="sd">        :param str request_id: The request ID the ISY supplied on a request to</span>
<span class="sd">                               the node server.</span>
<span class="sd">        :param bool success: Indicates if the request was sucessful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.pong"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends pong reply to Polyglot&#39;s ping request. This verifies that the</span>
<span class="sd">        communication between the Node Server and Polyglot is functioning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;pong&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells Polyglot that this Node Server is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s">&#39;exit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c"># manage handlers</span></div>
<div class="viewcode-block" id="PolyglotConnector.listen"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an event handler. Returns True on success. Event names are</span>
<span class="sd">        defined in `commands`. Handlers must be callable.</span>

<span class="sd">        :param str event: Then event name to listen for.</span>
<span class="sd">        :param callable handler: The callable event handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Ryan M. Kraus.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>